import{c as m,aI as c,aH as p,bH as F}from"./index-c6xvjn-C.js";import{d as _,e as P,h as b}from"./tanstack-aN5NUOUd.js";import"./radix-x8H_F-uE.js";const w="main",y="addons";function A(e){if(!e)return null;try{return e.length===256?(console.warn("parseJsonField: Skipping JSON parsing - appears to be truncated at 256 characters"),null):!e.trim().endsWith("}")&&!e.trim().endsWith("]")?(console.warn("JSON appears to be truncated in parseJsonField:",{length:e.length,ending:e.slice(-20)}),null):JSON.parse(e)}catch(t){return console.error("Failed to parse JSON in parseJsonField:",{error:t,errorMessage:t instanceof Error?t.message:"Unknown error",jsonLength:e.length,jsonStart:e.substring(0,100),jsonEnd:e.substring(e.length-100)}),null}}function q(e){const t={...e};return e.curseforge_raw&&(typeof e.curseforge_raw=="string"?t.curseforge_raw_parsed=A(e.curseforge_raw):t.curseforge_raw_parsed=e.curseforge_raw),e.modrinth_raw&&(typeof e.modrinth_raw=="string"?t.modrinth_raw_parsed=A(e.modrinth_raw):t.modrinth_raw_parsed=e.modrinth_raw),t}const K=e=>{const t=m.c(7);let o,r;t[0]!==e?(o=["addon","slug",e],r=async()=>{if(!e)return null;try{const a=await p.listDocuments(w,y,[c.equal("slug",e)]);if(a.documents.length===0)return null;const i=a.documents[0];return q(i)}catch(a){const i=a;throw console.error("Error fetching addon by slug:",i),i}},t[0]=e,t[1]=o,t[2]=r):(o=t[1],r=t[2]);const n=!!e;let s;return t[3]!==o||t[4]!==r||t[5]!==n?(s={queryKey:o,queryFn:r,enabled:n,staleTime:3e5,retry:!1},t[3]=o,t[4]=r,t[5]=n,t[6]=s):s=t[6],_(s)},O=()=>{const e=m.c(1);let t;return e[0]===Symbol.for("react.memo_cache_sentinel")?(t={queryKey:["addons","all"],queryFn:C,staleTime:6e5},e[0]=t):t=e[0],_(t)},S=(e,t,o)=>{const r=m.c(6);let n;r[0]!==e?(n=e===void 0?{}:e,r[0]=e,r[1]=n):n=r[1];const s=n,a=t===void 0?1:t,i=o;let u;return r[2]!==s||r[3]!==i||r[4]!==a?(u={queryKey:["addons","admin",s,a,i],queryFn:async()=>{const l=[c.limit(i),c.offset((a-1)*i),c.orderDesc("$createdAt")];s.reviewStatus==="all"?l.push(c.equal("isValid",!0)):s.reviewStatus==="reviewed"?l.push(c.equal("isChecked",!0)):s.reviewStatus==="unreviewed"?l.push(c.equal("isChecked",!1)):s.reviewStatus==="unsorted"&&l.push(c.equal("isValid",!1)),s.isValid!==void 0&&l.push(c.equal("isValid",s.isValid));const d=await p.listDocuments(w,y,l);let f=d.documents.map(q);if(s.search){const h=s.search.toLowerCase();f=f.filter(v=>v.name.toLowerCase().includes(h)||v.authors?.join(", ").toLowerCase().includes(h)||v.description?.toLowerCase().includes(h))}const g=Math.ceil(d.total/i);return{addons:f,total:d.total,totalPages:g,hasNextPage:a<g,hasPreviousPage:a>1,currentPage:a}},staleTime:12e4,placeholderData:E},r[2]=s,r[3]=i,r[4]=a,r[5]=u):u=r[5],_(u)},V=(e,t,o)=>{const r=m.c(9),n=t===void 0?1:t,s=o;let a,i;r[0]!==s||r[1]!==n||r[2]!==e?(a=["addons","search",e,n,s],i=async()=>{try{const d=[c.limit(s),c.offset((n-1)*s),c.orderDesc("$createdAt")];e.trim()&&d.push(c.or([c.search("name",e.trim()),c.search("description",e.trim()),c.search("authors",e.trim())]));const f=await p.listDocuments(w,y,d),g=f.documents.map(q),h=Math.ceil(f.total/s);return{addons:g,total:f.total,totalPages:h,hasNextPage:n<h,hasPreviousPage:n>1,currentPage:n}}catch(d){throw console.error("Error searching addons:",d),new Error("Failed to search addons")}},r[0]=s,r[1]=n,r[2]=e,r[3]=a,r[4]=i):(a=r[3],i=r[4]);const u=e.trim().length>0;let l;return r[5]!==a||r[6]!==i||r[7]!==u?(l={queryKey:a,queryFn:i,enabled:u,staleTime:12e4},r[5]=a,r[6]=i,r[7]=u,r[8]=l):l=r[8],_(l)},k=()=>{const e=m.c(2),t=P();let o;return e[0]!==t?(o={mutationFn:J,onSuccess:()=>{t.invalidateQueries({queryKey:["addons","list"]}),t.invalidateQueries({queryKey:["searchAddons"]})}},e[0]=t,e[1]=o):o=e[1],b(o)};function D(e){return q(e)}async function C(){let e=0,t=[];for(;;){const o=await p.listDocuments(w,y,[c.limit(100),c.offset(e)]),r=o.documents.map(D);if(t=[...t,...r],o.documents.length<100)break;e=e+100}return t}function E(e){return e}async function J(e){const{addonId:t,data:o}=e;try{const{curseforge_raw:r,modrinth_raw:n,...s}=o,a=F.safeParse(s);a.success||console.error("Validation error:",a.error.format());const i={...a.data};return await p.updateDocument(w,y,t,i)}catch(r){const n=r;throw console.error("Error updating addon:",n),n}}export{O as a,k as b,S as c,V as d,K as u};
