import{d as A}from"./tanstack-57jHkLwp.js";import{aB as D}from"./index-BNMRn6sK.js";import{r as g}from"./radix-bXgmYFMM.js";function O(c){const r={...c};if(typeof r.curseforge_raw=="string"&&r.curseforge_raw.trim()!=="")try{const t=r.curseforge_raw.trim();if(!t.startsWith("{")&&!t.startsWith("["))return r.curseforge_raw_parsed=null,r;r.curseforge_raw_parsed=JSON.parse(r.curseforge_raw)}catch(t){r.curseforge_raw.length>0&&console.debug("Failed to parse curseforge_raw JSON",t),r.curseforge_raw_parsed=null}else r.curseforge_raw_parsed=null;if(typeof r.modrinth_raw=="string"&&r.modrinth_raw.trim()!=="")try{const t=r.modrinth_raw.trim();if(!t.startsWith("{")&&!t.startsWith("["))return r.modrinth_raw_parsed=null,r;if(r.modrinth_raw.length===256)return console.debug("Skipping modrinth_raw parsing - appears to be truncated at 256 characters"),r.modrinth_raw_parsed=null,r;if(r.modrinth_raw.length>0&&!t.endsWith("}")&&!t.endsWith("]"))return console.debug("Modrinth JSON appears to be truncated:",{length:r.modrinth_raw.length,ending:r.modrinth_raw.slice(-20)}),r.modrinth_raw_parsed=null,r;r.modrinth_raw_parsed=JSON.parse(r.modrinth_raw)}catch(t){r.modrinth_raw.length>0&&console.debug("Failed to parse modrinth_raw JSON in search:",{error:t,errorMessage:t instanceof Error?t.message:"Unknown error",jsonLength:r.modrinth_raw.length,jsonStart:r.modrinth_raw.substring(0,50),jsonEnd:r.modrinth_raw.substring(Math.max(0,r.modrinth_raw.length-50))}),r.modrinth_raw_parsed=null}else r.modrinth_raw_parsed=null;return r}const j=({query:c,page:r,filterString:t,sort:d,limit:n=16,includeFacets:h=!1,category:u,version:l,loaders:f})=>{const _=c||"*",m=()=>{if(t)return t;const e=[],a=(i,o)=>{if(o&&o!=="all"&&o!=="All"){const x=o.includes(" ")?`"${o}"`:o;e.push(`${i} = ${x}`)}};return a("loaders",f),a("categories",u),a("minecraft_versions",l),e.push("isValid = true"),e.length>0?e.join(" AND "):""},p=()=>{if(!(!d||d==="relevance"))return[d]},{data:s,isLoading:w,isError:b,error:y,isFetching:H}=A({queryKey:["searchAddons",_,r,t||{category:u,version:l,loaders:f},d,n,h],queryFn:async()=>{try{const e=D.index("addons"),a={limit:n,offset:(r-1)*n,filter:m(),sort:p(),attributesToHighlight:["name","description"],highlightPreTag:"<mark>",highlightPostTag:"</mark>"};h&&(a.facets=["categories","loaders","minecraft_versions","authors"]);const i=await e.search(_,a);return{hits:i.hits,totalHits:i.estimatedTotalHits??0,facetDistribution:h?i.facetDistribution:void 0}}catch(e){return console.warn("Search failed, returning empty results:",e),{hits:[],totalHits:0,facetDistribution:void 0}}},retry:!1}),[N,S]=g.useState(!1);return g.useEffect(()=>{if(s){const e=(r-1)*n+(s.hits?.length||0)<(s.totalHits||0);S(e)}},[s,r,n]),{data:s?.hits?.map(e=>O(e._formatted||e))||[],isLoading:w,isError:b,error:y,isFetching:H,hasNextPage:N,totalHits:s?.totalHits??0,facetDistribution:s?.facetDistribution,page:r,limit:n}};export{j as u};
