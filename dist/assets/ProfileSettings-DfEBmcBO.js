import{r as f,j as e}from"./radix-B53Irp0y.js";import{m as K,A as D,cK as s,cL as V,aS as A,aU as v,cM as G,cN as q,F as _,bl as Y,bm as ee,bn as se,cI as B,n as J,U as te,ac as W,r as L,P as ae,bJ as ie,X as re,as as oe,aI as ne,by as le,cO as ce,cP as de}from"./index-BYSF1fK8.js";import{g as ue,f as ge,L as pe}from"./ecoFacts-CQwCLRGp.js";import"./tanstack-BnyC6HL-.js";import"./animation-DCGi2G0G.js";/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const me=[["line",{x1:"6",x2:"10",y1:"11",y2:"11",key:"1gktln"}],["line",{x1:"8",x2:"8",y1:"9",y2:"13",key:"qnk9ow"}],["line",{x1:"15",x2:"15.01",y1:"12",y2:"12",key:"krot7o"}],["line",{x1:"18",x2:"18.01",y1:"10",y2:"10",key:"1lcuu1"}],["path",{d:"M17.32 5H6.68a4 4 0 0 0-3.978 3.59c-.006.052-.01.101-.017.152C2.604 9.416 2 14.456 2 16a3 3 0 0 0 3 3c1 0 1.5-.5 2-1l1.414-1.414A2 2 0 0 1 9.828 16h4.344a2 2 0 0 1 1.414.586L17 18c.5.5 1 1 2 1a3 3 0 0 0 3-3c0-1.545-.604-6.584-.685-7.258-.007-.05-.011-.1-.017-.151A4 4 0 0 0 17.32 5z",key:"mfqc10"}]],fe=K("gamepad-2",me);/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const he=[["circle",{cx:"12",cy:"8",r:"5",key:"1hypcn"}],["path",{d:"M20 21a8 8 0 0 0-16 0",key:"rfgkzh"}]],xe=K("user-round",he);function be({currentAvatar:g,onAvatarChange:S,disabled:k=!1}){const F=D(r=>r.preferences),[a,c]=f.useState({stage:"idle",progress:0,message:""}),[$,d]=f.useState(""),[j,h]=f.useState(!1),w=f.useCallback(()=>{setTimeout(()=>{c({stage:"idle",progress:0,message:""})},3e3)},[]),I=f.useCallback(async r=>{let t=null;const p=F?.avatar||"",n=p||g||"",m=n&&(n.includes("appwrite")||n.includes("api.blueprint-create.com"));if(s(`ğŸ” DEBUG: Starting upload with currentAvatar prop: "${g}"`,0,"debug"),s(`ğŸ” DEBUG: Store avatar URL: "${p}"`,0,"debug"),s(`ğŸ” DEBUG: Final avatarUrlToCheck: "${n}"`,0,"debug"),s(`ğŸ” DEBUG: avatarUrlToCheck includes 'appwrite': ${n?.includes("appwrite")}`,0,"debug"),s(`ğŸ” DEBUG: avatarUrlToCheck includes 'api.blueprint-create.com': ${n?.includes("api.blueprint-create.com")}`,0,"debug"),s(`ğŸ” DEBUG: isAppwriteUrl: ${m}`,0,"debug"),m){s(`ğŸ“¸ Current avatar URL detected: ${n}`,0,"action");const i=[/\/buckets\/[^/]+\/files\/([a-zA-Z0-9]+)\/preview(?:\?|$)/,/\/buckets\/[^/]+\/files\/([a-zA-Z0-9]+)\/view(?:\?|$)/,/\/buckets\/[^/]+\/files\/([a-zA-Z0-9]+)(?:\/|$|\?)/,/\/files\/([a-zA-Z0-9]+)\/preview(?:\?|$)/,/\/files\/([a-zA-Z0-9]+)\/view(?:\?|$)/,/\/files\/([a-zA-Z0-9]+)(?:\/|$|\?)/];for(let o=0;o<i.length;o++){const E=i[o],N=E.exec(n);if(s(`Pattern ${o+1}: ${E.source} - Match: ${N?N[1]:"no match"}`,0,"debug"),N&&N[1]){t=N[1],s(`âœ“ Extracted old avatar ID: ${t} using pattern ${o+1}`,0,"action");break}}if(!t){s(`âŒ Could not extract file ID from URL: ${n}`,3,"action");const o=n.match(/files\/([a-zA-Z0-9]+)/);o&&o[1]&&(t=o[1],s(`âœ“ Extracted using simple pattern: ${t}`,0,"action"))}}try{c({stage:"uploading",progress:20,message:"Uploading image..."});const i=V.unique(),o=await A.createFile(v.AVATARS,i,r);s(`Original image uploaded: ${o.$id}`,0,"action"),c({stage:"compressing",progress:50,message:ue()});const N=await new G(q).createExecution("image-compressor",JSON.stringify({bucketId:v.AVATARS,fileId:o.$id,quality:90,width:500,height:500,preserveOriginal:!1}));let R=0,U=N;for(;U.status==="waiting"||U.status==="processing";){if(R>30)throw new Error("Image compression timeout");await new Promise(b=>setTimeout(b,1e3)),U=await new G(q).getExecution("image-compressor",U.$id),R++,c(b=>({...b,progress:Math.min(50+R*1.5,80),message:`Processing image... (${R}s)`}))}if(U.status!=="completed")throw new Error(`Compression failed: ${U.responseBody||"Unknown error"}`);const l=JSON.parse(U.responseBody);if(!l.success&&!l.uploadFailed)throw new Error(l.error||"Compression failed");let z=l.compressed.id,Z=!1;if(l.uploadFailed&&l.compressed.base64){s("Compression succeeded but upload failed, uploading from client...",1,"action");const b=await(await fetch(`data:image/webp;base64,${l.compressed.base64}`)).blob(),C=new File([b],l.compressed.name,{type:"image/webp"});z=(await A.createFile(v.AVATARS,V.unique(),C)).$id,s(`Client-side upload completed: ${z}`,0,"action");try{await A.deleteFile(v.AVATARS,o.$id),s(`Deleted original uncompressed file: ${o.$id}`,0,"action"),Z=!0}catch(M){s(`Failed to delete original file: ${M}`,2,"action")}}else s(`Image compressed: ${z}`,0,"action"),Z=l.original.deleted;Z||s(`Warning: Original file ${o.$id} may still exist`,1,"action"),c({stage:"saving",progress:90,message:"Saving compressed image...",details:{originalSize:l.original.size,compressedSize:l.compressed.size,compressionRatio:l.stats.compressionRatio}});const Q=A.getFilePreview(v.AVATARS,z).toString();c({stage:"complete",progress:100,message:`Image compressed successfully! Saved ${l.stats.compressionRatio} space`,details:{originalSize:l.original.size,compressedSize:l.compressed.size,compressionRatio:l.stats.compressionRatio}});const P=ge(l.original.size||r.size,l.compressed.size||0);if(_.success(P.title,{description:P.description,duration:8e3,icon:e.jsx(pe,{className:"text-green-500"})}),S(Q),s(`ğŸ” DEBUG: About to check for old avatar deletion. oldAvatarId: "${t}"`,0,"debug"),s(`ğŸ” DEBUG: compressedFileId: "${z}"`,0,"debug"),t)if(t===z)s(`Skipping deletion - old and new IDs are the same: ${t}`,1,"action");else{s(`ğŸ—‘ï¸ Attempting to delete old avatar: ${t} from bucket: ${v.AVATARS}`,0,"action");try{const x=await A.getFile(v.AVATARS,t);s(`âœ“ Old avatar file exists: ${x.name} (${x.sizeOriginal} bytes)`,0,"action")}catch(x){const b=x instanceof Error?x.message:String(x);if(s(`â„¹ï¸ Old avatar file doesn't exist or can't be accessed: ${b}`,1,"action"),b.includes("404")||b.includes("not found")){s(`Old avatar ${t} was already deleted`,1,"action");return}}try{s(`ğŸ”¥ Executing deletion: storage.deleteFile("${v.AVATARS}", "${t}")`,0,"debug");const x=await A.deleteFile(v.AVATARS,t);s(`âœ… Successfully deleted old avatar: ${t}`,0,"action"),s(`Delete result: ${JSON.stringify(x)}`,0,"debug"),_.success("Previous avatar removed successfully",{duration:3e3})}catch(x){const b=x,C=b?.message||String(x)||"Unknown error",T=b?.code||"unknown",M=b?.type||"unknown";s(`âŒ Failed to delete old avatar ${t}: ${C} (code: ${T}, type: ${M})`,3,"action"),C.includes("404")||C.includes("not found")||T===404?(s(`â„¹ï¸ Old avatar ${t} was already deleted or doesn't exist`,1,"action"),_.info("Previous avatar was already removed",{duration:2e3})):(console.error("Avatar deletion error details:",{error:x,message:C,code:T,type:M,fileId:t,bucketId:v.AVATARS}),_.error(`Could not remove previous avatar: ${C}`,{duration:5e3}))}}else s("âš ï¸ No old avatar ID found to delete",1,"action"),s(`ğŸ” DEBUG: Why no deletion? avatarUrlToCheck: "${n}"`,0,"debug"),s(`ğŸ” DEBUG: isAppwriteUrl: ${m}`,0,"debug");w()}catch(i){s(`Avatar upload error: ${i}`,3,"action"),c({stage:"error",progress:0,message:i instanceof Error?i.message:"Failed to upload image"}),w()}},[g,F,S,w]),u=f.useCallback(async r=>{const t=r.target.files?.[0];if(t){if(t.size>10*1024*1024){c({stage:"error",progress:0,message:"File size must be less than 10MB"}),w();return}if(!t.type.startsWith("image/")){c({stage:"error",progress:0,message:"Please select a valid image file"}),w();return}await I(t)}},[I,w]),y=f.useCallback(async()=>{if($.trim())try{h(!0);const r=`https://minotar.net/helm/${$}/500`,t=new Image;t.onload=async()=>{if(s(`Minecraft avatar set: ${r}`,0,"action"),S(r),g&&(g.includes("appwrite")||g.includes("api.blueprint-create.com"))){s(`Deleting old avatar before Minecraft skin: ${g}`,0,"action");const n=[/\/buckets\/[^/]+\/files\/([a-zA-Z0-9]+)\/preview(?:\?|$)/,/\/buckets\/[^/]+\/files\/([a-zA-Z0-9]+)\/view(?:\?|$)/,/\/buckets\/[^/]+\/files\/([a-zA-Z0-9]+)(?:\/|$|\?)/,/\/files\/([a-zA-Z0-9]+)\/preview(?:\?|$)/,/\/files\/([a-zA-Z0-9]+)\/view(?:\?|$)/,/\/files\/([a-zA-Z0-9]+)(?:\/|$|\?)/];let m=null;for(const i of n){const o=i.exec(g);if(o&&o[1]){m=o[1];break}}if(!m){const i=g.match(/files\/([a-zA-Z0-9]+)/);i&&i[1]&&(m=i[1],s(`Extracted using simple pattern: ${m}`,0,"action"))}if(m)try{await A.deleteFile(v.AVATARS,m),s(`âœ“ Deleted old avatar after setting Minecraft skin: ${m}`,0,"action")}catch(i){const E=i?.message||String(i)||"Unknown error";E.includes("404")||E.includes("not found")?s(`Old avatar ${m} was already deleted or doesn't exist`,1,"action"):s(`Failed to delete old avatar: ${E}`,2,"action")}else s(`âŒ Could not extract file ID from avatar URL: ${g}`,1,"action")}d(""),h(!1),c({stage:"complete",progress:100,message:"Minecraft avatar set successfully!"}),w()},t.onerror=p=>{c({stage:"error",progress:0,message:"Minecraft username not found"}),h(!1),w()},t.src=r}catch{c({stage:"error",progress:0,message:"Failed to fetch Minecraft avatar"}),h(!1),w()}},[$,g,S,w]),O=f.useCallback(async r=>{s(`ğŸ§ª Testing avatar deletion for file ID: ${r}`,0,"debug");try{const t=await A.getFile(v.AVATARS,r);s(`âœ“ File exists: ${t.name} (${t.sizeOriginal} bytes)`,0,"debug");const p=await A.deleteFile(v.AVATARS,r);return s(`âœ… Test deletion successful: ${JSON.stringify(p)}`,0,"debug"),console.log("Test deletion result:",p),{success:!0,result:p}}catch(t){const p=t instanceof Error?t.message:String(t);return s(`âŒ Test deletion failed: ${p}`,3,"debug"),console.error("Test deletion error:",t),{success:!1,error:t}}},[]);f.useEffect(()=>(window.testAvatarDeletion=O,window.debugAvatarExtraction=r=>{const t=[/\/buckets\/[^/]+\/files\/([a-zA-Z0-9]+)\/preview(?:\?|$)/,/\/buckets\/[^/]+\/files\/([a-zA-Z0-9]+)\/view(?:\?|$)/,/\/buckets\/[^/]+\/files\/([a-zA-Z0-9]+)(?:\/|$|\?)/,/\/files\/([a-zA-Z0-9]+)\/preview(?:\?|$)/,/\/files\/([a-zA-Z0-9]+)\/view(?:\?|$)/,/\/files\/([a-zA-Z0-9]+)(?:\/|$|\?)/];for(let n=0;n<t.length;n++){const m=t[n],i=m.exec(r);if(console.log(`Pattern ${n+1}: ${m.source} - Match: ${i?i[1]:"no match"}`),i&&i[1])return console.log(`âœ“ Extracted file ID: ${i[1]}`),i[1]}const p=r.match(/files\/([a-zA-Z0-9]+)/);return p&&p[1]?(console.log(`âœ“ Simple pattern worked: ${p[1]}`),p[1]):(console.log("âŒ No patterns matched"),null)},()=>{delete window.testAvatarDeletion,delete window.debugAvatarExtraction}),[O]);const H=()=>{switch(a.stage){case"uploading":case"compressing":case"saving":return e.jsx(ne,{className:"h-4 w-4 animate-spin"});case"complete":return e.jsx(oe,{className:"h-4 w-4"});case"error":return e.jsx(re,{className:"h-4 w-4"});default:return e.jsx(ie,{className:"h-4 w-4"})}},X=()=>{switch(a.stage){case"complete":return"text-green-600 dark:text-green-400";case"error":return"text-red-600 dark:text-red-400";default:return"text-blue-600 dark:text-blue-400"}};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsxs(Y,{className:"h-20 w-20",children:[e.jsx(ee,{src:g}),e.jsx(se,{children:e.jsx(xe,{className:"h-10 w-10"})})]}),e.jsxs("div",{className:"flex-1 space-y-3",children:[e.jsx("div",{className:"flex gap-2",children:e.jsxs(B,{htmlFor:"picture",className:"cursor-pointer",children:[e.jsxs("div",{className:J("flex items-center gap-2 rounded-md px-4 py-2 text-sm transition-colors","bg-secondary hover:bg-secondary/80 text-secondary-foreground",k&&"opacity-50 cursor-not-allowed"),children:[e.jsx(te,{className:"h-4 w-4"}),"Upload Image"]}),e.jsx("input",{id:"picture",type:"file",className:"hidden",accept:"image/*",onChange:u,disabled:k||a.stage!=="idle"})]})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(W,{placeholder:"Minecraft username",value:$,onChange:r=>d(r.target.value),onKeyPress:r=>{r.key==="Enter"&&y()},disabled:k||j,className:"w-48"}),e.jsxs(L,{type:"button",variant:"secondary",size:"sm",onClick:y,disabled:k||j||!$.trim(),children:[e.jsx(fe,{className:"h-4 w-4 mr-2"}),"Use Minecraft"]})]})]})]}),a.stage!=="idle"&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:J("flex items-center gap-2",X()),children:[H(),e.jsx("span",{className:"text-sm font-medium",children:a.message})]}),a.stage!=="complete"&&a.stage!=="error"&&e.jsx(ae,{value:a.progress,className:"h-2"}),a.details&&e.jsxs("div",{className:"text-xs text-muted-foreground space-y-1",children:[a.details.originalSize&&e.jsxs("div",{children:["Original: ",(a.details.originalSize/1024).toFixed(1)," KB â†’ Compressed: ",(a.details.compressedSize/1024).toFixed(1)," KB"]}),a.details.compressionRatio&&e.jsxs("div",{children:["Space saved: ",a.details.compressionRatio]})]})]})]})}function Se(){const[g,S]=f.useState(!1),[k,F]=f.useState(null),[a,c]=f.useState({username:"",bio:"",avatar:""}),$=D(u=>u.user),d=D(u=>u.preferences),j=D(u=>u.updatePreferences),{t:h}=le();f.useEffect(()=>{$&&c({username:$?.name||"",bio:d?.bio??"",avatar:d?.avatar??""})},[$,d]);const w=f.useCallback(async()=>{S(!0);try{s("Saving of the profile in progress",0,"action"),await ce.updateName(a.username),await j({theme:d?.theme??"light",language:d?.language??"en",notificationsEnabled:d?.notificationsEnabled||!1,roles:d?.roles||[],bio:a.bio,avatar:a.avatar}),s("Saving of the profile done",0,"action")}catch(u){throw s("Error while saving the profile ",3,"action"),F("Error while saving the profile"),u}finally{S(!1)}},[d,a,j]),I=f.useCallback(async u=>{c(y=>({...y,avatar:u})),await j({theme:d?.theme??"light",language:d?.language??"en",notificationsEnabled:d?.notificationsEnabled||!1,roles:d?.roles||[],bio:a.bio,avatar:u}),s("Avatar updated successfully",0,"action")},[a.bio,d,j]);return k?e.jsx("div",{className:"text-destructive",children:k}):$?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"mb-2 text-2xl font-bold",children:h("settings.user-settings.public-profile.title")}),e.jsx("p",{className:"text-foreground-muted text-sm",children:h("settings.user-settings.public-profile.description")})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"mb-4 text-lg font-semibold",children:h("settings.user-settings.public-profile.picture.title")}),e.jsx(be,{currentAvatar:a.avatar,onAvatarChange:I,disabled:g})]}),e.jsxs("div",{children:[e.jsx(B,{htmlFor:"username",children:h("settings.user-settings.public-profile.username.title")}),e.jsx("p",{className:"text-foreground-muted mb-2 text-sm",children:h("settings.user-settings.public-profile.username.description")}),e.jsx(W,{id:"username",value:a.username,onChange:u=>c(y=>({...y,username:u.target.value})),className:"max-w-md"})]}),e.jsxs("div",{children:[e.jsx(B,{htmlFor:"bio",children:h("settings.user-settings.public-profile.bio.title")}),e.jsx("p",{className:"text-foreground-muted mb-2 text-sm",children:h("settings.user-settings.public-profile.bio.description")}),e.jsx(de,{id:"bio",value:a.bio,onChange:u=>c(y=>({...y,bio:u.target.value})),className:"min-h-[100px]"})]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx(L,{onClick:w,disabled:g,children:h("settings.user-settings.public-profile.actions.save")}),e.jsx(L,{variant:"secondary",asChild:!0,children:e.jsx("a",{href:"/profile",children:h("settings.user-settings.public-profile.actions.visit")})})]})]})]}):e.jsx("div",{children:"Loading..."})}export{Se as default};
